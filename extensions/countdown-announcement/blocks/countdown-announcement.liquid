{% schema %}
{
  "name": "Countdown Announcement",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "text",
      "label": "Header Text",
      "default": "ðŸ”¥ Sale Ends In"
    },
    {
      "type": "checkbox",
      "id": "show_countdown",
      "label": "Show Countdown Timer",
      "default": true
    },
    {
      "type": "text",
      "id": "end_date",
      "label": "Offer End Date",
      "info": "Enter YYYY-MM-DD (2026-01-01) or DD/MM/YYYY (01/01/2026). Leave blank = 15 days from today.",
      "default": "2026-01-01"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#dc2626"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "font_size",
      "min": 12,
      "max": 48,
      "step": 1,
      "unit": "px",
      "label": "Font Size",
      "default": 20
    },
    {
      "type": "font_picker",
      "id": "font_family",
      "label": "Font Family",
      "default": "helvetica_n4"
    },
    {
      "type": "range",
      "id": "padding",
      "min": 4,
      "max": 40,
      "step": 1,
      "unit": "px",
      "label": "Vertical Padding",
      "default": 12
    }
  ]
}
{% endschema %}

<style>
{%- if section.settings.font_family -%}
  {{ block.settings.font_family | font_face: font_display: 'swap' }}
{%- endif -%}

/* Wrapper */
#noticebar-wrapper-{{ section.id }} {
  width: 100%;
}

/* Main bar */
#noticebar-{{ section.id }} {
  background: {{ block.settings.bg_color }} !important;
  color: {{ block.settings.text_color }} !important;
  padding: {{ block.settings.padding }}px 20px !important;
  font-size: {{ block.settings.font_size }}px !important;
  font-family: {{ block.settings.font_family.family }}, {{ block.settings.font_family.fallback_families }}, sans-serif !important;
  font-weight: {{ block.settings.font_family.weight | default: 700 }} !important;
  box-sizing: border-box !important;
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
}

/* When NO countdown - center the text */
#noticebar-{{ section.id }}:not(:has(.countdown-timer)) {
  justify-content: center !important;
  text-align: center !important;
}

/* Inner layout: text + countdown with good spacing */
#noticebar-{{ section.id }} .noticebar-content {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 40px !important;
  width: 100% !important;
  max-width: 1200px !important;
  margin: 0 auto !important;
}

/* Header text (left/center) - White text */
#noticebar-{{ section.id }} .notice-text {
  white-space: nowrap !important;
  font-weight: 700 !important;
  margin: 0 !important;
  color: {{ block.settings.text_color }} !important;
  font-size: 1.2em !important;
  letter-spacing: 1px !important;
}

/* Countdown container (right) */
#noticebar-{{ section.id }} .countdown-timer {
  display: flex !important;
  align-items: center !important;
  gap: 12px !important;
}

/* Individual time box - Large digital style */
#noticebar-{{ section.id }} .time-unit {
  background: rgba(255, 255, 255, 0.1) !important;
  backdrop-filter: blur(10px) !important;
  border: 2px solid rgba(255, 255, 255, 0.2) !important;
  padding: 12px 16px !important;
  border-radius: 12px !important;
  min-width: 85px !important;
  min-height: 35px !important;
  text-align: center !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
  font-family: 'Courier New', monospace, sans-serif !important;
  font-weight: 800 !important;
  color: {{ block.settings.text_color }} !important;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
  position: relative !important;
}

#noticebar-{{ section.id }} .time-unit::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
  border-radius: 14px;
  z-index: -1;
}

/* Number display - Large bold */
#noticebar-{{ section.id }} .time-unit > div:first-child {
  font-size: 2.2em !important;
  line-height: 1 !important;
  font-weight: 900 !important;
  text-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
  margin-bottom: 2px !important;
}

/* Label - Smaller below numbers */
#noticebar-{{ section.id }} .time-label {
  font-size: 0.65em !important;
  opacity: 0.85 !important;
  font-weight: 600 !important;
  letter-spacing: 1px !important;
  text-transform: uppercase !important;
}

/* Hide when expired */
#noticebar-{{ section.id }}.noticebar-hidden {
  display: none !important;
}

/* Mobile responsive */
@media (max-width: 749px) {
  #noticebar-{{ section.id }} .noticebar-content {
    flex-direction: column !important;
    gap: 24px !important;
    text-align: center !important;
  }

  #noticebar-{{ section.id }} .notice-text {
    white-space: normal !important;
    font-size: 1.1em !important;
  }

  #noticebar-{{ section.id }} .countdown-timer {
    gap: 10px !important;
  }

  #noticebar-{{ section.id }} .time-unit {
    min-width: 70px !important;
    height: 70px !important;
    padding: 10px 12px !important;
  }

  #noticebar-{{ section.id }} .time-unit > div:first-child {
    font-size: 1.8em !important;
  }
}

/* Animation for number changes */
@keyframes glow {
  0% { box-shadow: 0 0 20px rgba(255,255,255,0.3); }
  50% { box-shadow: 0 0 30px rgba(255,255,255,0.6); }
  100% { box-shadow: 0 0 20px rgba(255,255,255,0.3); }
}

#noticebar-{{ section.id }} .time-unit.changing {
  animation: glow 0.6s ease-in-out !important;
}
</style>


<div id="noticebar-wrapper-{{ section.id }}">
  <div class="noticebar-countdown" id="noticebar-{{ section.id }}">
    
    <!-- Header text - ALWAYS shows -->
    <span class="notice-text">
      {{ block.settings.text }}
    </span>

    <!-- Countdown timer - ONLY shows if enabled -->
    {% if block.settings.show_countdown %}
      <div class="countdown-timer" id="countdown-{{ section.id }}"></div>
    {% endif %}
    
  </div>
</div>


<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const bar = document.getElementById('noticebar-' + sectionId);
  const timer = document.getElementById('countdown-' + sectionId);
  
  // If countdown is disabled or elements don't exist, exit early
  if (!timer || !{{ block.settings.show_countdown | json }}) {
    return;
  }

  const now = new Date();
  const rawInput = '{{ block.settings.end_date | strip }}'.trim();
  let endDate;

  // Parse only if merchant actually entered something
  if (rawInput) {
    // Try ISO: YYYY-MM-DD
    endDate = new Date(rawInput);

    // If that fails, try DD/MM/YYYY or DD-MM-YYYY
    if (isNaN(endDate.getTime())) {
      const m = rawInput.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
      if (m) {
        const day = parseInt(m[1], 10);
        const month = parseInt(m[2], 10) - 1;
        const year = parseInt(m[3], 10);
        endDate = new Date(year, month, day, 23, 59, 59);
      }
    }

    if (!isNaN(endDate.getTime())) {
      endDate.setHours(23, 59, 59, 999);
    }
  }

  // Fallback: if empty or invalid â‡’ 15 days from today
  if (!endDate || isNaN(endDate.getTime())) {
    endDate = new Date(now);
    endDate.setDate(now.getDate() + 15);
    endDate.setHours(23, 59, 59, 999);
  }

  function updateTimer() {
    const current = new Date();
    const diff = endDate - current;

    if (diff <= 0) {
      bar.classList.add('noticebar-hidden');
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    timer.innerHTML = `
      <div class="time-unit">
        <div>${days.toString().padStart(2, '0')}</div>
        <div class="time-label">Days</div>
      </div>
      <div class="time-unit">
        <div>${hours.toString().padStart(2, '0')}</div>
        <div class="time-label">Hrs</div>
      </div>
      <div class="time-unit">
        <div>${minutes.toString().padStart(2, '0')}</div>
        <div class="time-label">Mins</div>
      </div>
      <div class="time-unit">
        <div>${seconds.toString().padStart(2, '0')}</div>
        <div class="time-label">Secs</div>
      </div>
    `;
  }

  updateTimer();
  setInterval(updateTimer, 1000);
})();
</script>
